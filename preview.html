<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Times Widget Preview</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .preview-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .preview-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .preview-note strong {
            color: #856404;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        /* Widget Styles */
        .mptsi-widget { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 420px; overflow: hidden; margin: 0 auto; }
        .mptsi-header { text-align: center; padding: 14px 15px 10px; border-bottom: 1px solid #eee; }
        .mptsi-header h2 { font-size: 20px; font-weight: 600; color: #1a1a1a; margin: 0 0 4px 0; }
        .mptsi-header .date { font-size: 13px; color: #555; margin: 0; }
        .mptsi-table { padding: 6px 15px 10px; }
        .mptsi-row { display: grid; grid-template-columns: 95px 1fr 1fr 1fr; padding: 10px 0; border-bottom: 1px solid #f5f5f5; align-items: center; gap: 4px; }
        .mptsi-row.single-masjid { grid-template-columns: 100px 1fr 1fr; }
        .mptsi-row.header { border-bottom: 2px solid #eee; padding: 6px 0 8px; }
        .mptsi-row.header span { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #666; letter-spacing: 0.3px; }
        .mptsi-row:last-child { border-bottom: none; }
        .mptsi-row.active { background: #1e7b34; border-radius: 6px; margin: 4px -10px; padding: 10px; }
        .mptsi-row.active * { color: #ffffff !important; }
        .mptsi-name { display: flex; align-items: center; gap: 8px; font-weight: 500; color: #333; font-size: 14px; }
        .mptsi-name .icon { font-size: 18px; width: 22px; text-align: center; }
        .mptsi-time { text-align: center; font-size: 13px; color: #666; line-height: 1.3; }
        .mptsi-iqamah { text-align: center; font-size: 14px; font-weight: 600; color: #1a1a1a; line-height: 1.3; }
        .mptsi-alert { background: #1e7b34; color: #ffffff; text-align: center; padding: 10px 14px; margin: 6px 15px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .mptsi-alert, .mptsi-alert * { color: #ffffff !important; }
        .mptsi-header .mptsi-alert { margin: 10px 0 0 0; padding: 8px 12px; font-size: 11px; border-radius: 6px; }
        .mptsi-jumuah { padding: 12px 15px; border-top: 1px solid #eee; }
        .mptsi-jumuah-grid { display: flex; justify-content: center; gap: 0; flex-wrap: nowrap; }
        .mptsi-jumuah-item { text-align: center; padding: 4px 14px; flex-shrink: 0; }
        .mptsi-jumuah-item:not(:last-child) { border-right: 1px solid #ddd; }
        .mptsi-jumuah-time { font-size: 16px; font-weight: 600; color: #1a1a1a; }
        .mptsi-jumuah-label { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 0.3px; margin-top: 2px; }
        .mptsi-sun { display: flex; justify-content: space-between; padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #eee; }
        .mptsi-sun-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #333; }
        .mptsi-link { display: block; text-align: center; padding: 12px; background: #f0f7ff; color: #0066cc; text-decoration: none; font-size: 13px; font-weight: 500; border-top: 1px solid #e0e0e0; border-radius: 0 0 12px 12px; }
        .mptsi-link:hover { background: #e0efff; }
    </style>
</head>
<body>
    <div class="preview-container">
        <h1>Prayer Times Widget Preview</h1>

        <div class="preview-note">
            <strong>Live Data from Masjidi API:</strong>
            <ol>
                <li><strong>Azan column:</strong> Both masjids share the same Azan time (from primary masjid's API data)</li>
                <li><strong>Iqama columns:</strong> Each masjid shows its own iqama time, <strong>except Maghrib</strong> which uses the Azan time for both</li>
                <li><strong>Jumu'ah section:</strong> Shows Talk and Prayer times stacked, with labels below</li>
                <li><strong>Sunrise/Sunset:</strong> Labeled with "Sunrise" and "Sunset" text</li>
            </ol>
        </div>

        <div id="widget-container">
            <div class="loading">Loading prayer times...</div>
        </div>
    </div>

    <script>
        // Configuration - Update these masjid IDs as needed
        const CONFIG = {
            masjidId1: '3443',       // Primary masjid (ICF)
            masjidId2: '50059',      // Secondary masjid (Masjid Zakariya) - leave empty for single masjid
            masjidName1: 'ICF',
            masjidName2: 'Masjid Zakariya',
            apiKey: '123-test-key',
            highlightColor: '#1e7b34',
            highlightTextColor: '#ffffff'
        };

        // Format time to 12-hour format
        function formatTime(timeStr) {
            if (!timeStr || timeStr === '-' || timeStr === '' || timeStr === null || timeStr === undefined) {
                return '-';
            }

            try {
                // Handle "HH:MM am/pm" format from API (e.g., "05:53 am")
                const ampmMatch = timeStr.toString().match(/^(\d{1,2}):(\d{2})\s*(am|pm)$/i);
                if (ampmMatch) {
                    let hours = parseInt(ampmMatch[1]);
                    const minutes = ampmMatch[2];
                    const period = ampmMatch[3].toUpperCase();

                    // Convert to 12-hour format display
                    if (hours === 0) hours = 12;
                    if (hours > 12) hours = hours - 12;

                    return `${hours}:${minutes} ${period}`;
                }

                // Try parsing as ISO date string
                let date = new Date(timeStr);

                if (isNaN(date.getTime())) {
                    // Try parsing as time only (HH:MM or HH:MM:SS)
                    const parts = timeStr.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
                    if (parts) {
                        let hours = parseInt(parts[1]);
                        const minutes = parseInt(parts[2]);
                        date = new Date();
                        date.setHours(hours, minutes, 0, 0);
                    } else {
                        return timeStr;
                    }
                }

                if (isNaN(date.getTime())) {
                    return '-';
                }

                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) {
                console.error('Error parsing time:', timeStr, e);
                return '-';
            }
        }

        // Parse time string to minutes since midnight
        function parseTimeToMinutes(timeStr) {
            if (!timeStr) return null;

            // Handle "HH:MM am/pm" format (e.g., "05:53 am")
            const ampmMatch = timeStr.toString().match(/^(\d{1,2}):(\d{2})\s*(am|pm)$/i);
            if (ampmMatch) {
                let hours = parseInt(ampmMatch[1]);
                const minutes = parseInt(ampmMatch[2]);
                const period = ampmMatch[3].toLowerCase();

                if (period === 'pm' && hours !== 12) hours += 12;
                if (period === 'am' && hours === 12) hours = 0;

                return hours * 60 + minutes;
            }

            // Try ISO date
            const date = new Date(timeStr);
            if (!isNaN(date.getTime())) {
                return date.getHours() * 60 + date.getMinutes();
            }

            return null;
        }

        // Get active prayer based on current time
        function getActivePrayer(data) {
            try {
                const timezone = data.date?.timezone || data.timezone_for_masjid || data.timezoneId || 'America/Los_Angeles';
                const now = new Date();
                const currentTime = now.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false, hour: '2-digit', minute: '2-digit' });
                const currentMinutes = parseInt(currentTime.split(':')[0]) * 60 + parseInt(currentTime.split(':')[1]);

                const prayers = ['fajr', 'zuhr', 'asr', 'maghrib', 'isha'];
                const iqamaFields = {
                    fajr: 'fajr_iqama_time',
                    zuhr: 'zuhr_iqama_time',
                    asr: 'asr_iqama_time',
                    maghrib: 'magrib_start_time', // Maghrib uses azan time
                    isha: 'isha_iqama_time'
                };

                for (const prayer of prayers) {
                    const iqamaTime = data[iqamaFields[prayer]];
                    const iqamaMinutes = parseTimeToMinutes(iqamaTime);
                    if (iqamaMinutes !== null && currentMinutes < iqamaMinutes) {
                        return prayer;
                    }
                }
            } catch (e) {
                console.error('Error determining active prayer:', e);
            }
            return '';
        }

        // Fetch data from Masjidi API
        async function fetchMasjidData(masjidId) {
            if (!masjidId) return null;

            const url = `https://api.masjidiapp.com/v2/masjids/${masjidId}`;
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'apikey': CONFIG.apiKey
                    },
                    mode: 'cors'
                });
                if (!response.ok) {
                    console.error(`HTTP Error: ${response.status} ${response.statusText}`);
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                console.log(`Fetched data for masjid ${masjidId}:`, data);
                return data;
            } catch (error) {
                console.error('Masjidi API Error for masjid ' + masjidId + ':', error);
                return null;
            }
        }

        // Render the widget
        function renderWidget(data1, data2) {
            const container = document.getElementById('widget-container');

            if (!data1) {
                container.innerHTML = '<div class="error">Unable to load prayer times. Please check the Masjid ID.</div>';
                return;
            }

            const hasTwoMasjids = CONFIG.masjidId2 && data2 !== null;
            const timezone = data1.date?.timezone || data1.timezone_for_masjid || data1.timezoneId || 'America/Los_Angeles';

            // Format date - use date from API if available
            let todayDate;
            if (data1.date?.date) {
                const apiDate = new Date(data1.date.date);
                todayDate = apiDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            } else {
                const now = new Date();
                todayDate = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', timeZone: timezone });
            }
            const hijriDate = data1.hijri_date || '';

            // Get masjid names
            let masjidName1 = CONFIG.masjidName1 || data1.title || 'Masjid 1';
            let masjidName2 = CONFIG.masjidName2 || (data2 ? data2.title : 'Masjid 2');
            if (masjidName1.length > 20) masjidName1 = masjidName1.substring(0, 15) + '...';
            if (masjidName2.length > 20) masjidName2 = masjidName2.substring(0, 15) + '...';

            // Get active prayer
            const activePrayer = getActivePrayer(data1);

            // Prayer definitions
            const prayers = [
                { key: 'fajr', label: 'Fajr', icon: 'üåÖ', start: 'fajr_start_time', iqama: 'fajr_iqama_time' },
                { key: 'zuhr', label: 'Dhuhr', icon: '‚òÄÔ∏è', start: 'zuhr_start_time', iqama: 'zuhr_iqama_time' },
                { key: 'asr', label: 'Asr', icon: 'üå§Ô∏è', start: 'asr_start_time', iqama: 'asr_iqama_time' },
                { key: 'maghrib', label: 'Maghrib', icon: 'üåá', start: 'magrib_start_time', iqama: 'magrib_iqama_time' },
                { key: 'isha', label: 'Isha', icon: 'üåô', start: 'isha_start_time', iqama: 'isha_iqama_time' }
            ];

            // Build prayer rows
            let prayerRows = '';
            for (const prayer of prayers) {
                const startTime = formatTime(data1[prayer.start]);
                let iqamaTime1 = formatTime(data1[prayer.iqama]);
                let iqamaTime2 = data2 ? formatTime(data2[prayer.iqama]) : '-';

                // For Maghrib, use Azan time as Iqamah for both masjids
                if (prayer.key === 'maghrib') {
                    iqamaTime1 = startTime;
                    iqamaTime2 = startTime;
                }

                const isActive = activePrayer === prayer.key;
                const rowClass = `mptsi-row ${isActive ? 'active' : ''} ${!hasTwoMasjids ? 'single-masjid' : ''}`;

                prayerRows += `
                    <div class="${rowClass}">
                        <div class="mptsi-name">
                            <span class="icon">${prayer.icon}</span>
                            <span>${prayer.label}</span>
                        </div>
                        <div class="mptsi-time">${startTime}</div>
                        <div class="mptsi-iqamah">${iqamaTime1}</div>
                        ${hasTwoMasjids ? `<div class="mptsi-iqamah">${iqamaTime2}</div>` : ''}
                    </div>
                `;
            }

            // Iqamah change alert (from API field)
            const iqamahChange = data1.last_iqamah_time_change || '';
            const alertHtml = iqamahChange ? `<div class="mptsi-alert">${iqamahChange}</div>` : '';

            // Build upcoming changes banner based on next_iqamah_change data
            let changesHtml = '';

            // Helper function to get changes for a masjid
            function getChangesForMasjid(data, masjidName) {
                const nextChange = data.next_iqamah_change;
                if (!nextChange || !nextChange.change_date) {
                    return null;
                }

                // Parse date as local time (not UTC) to avoid timezone issues
                const dateParts = nextChange.change_date.split('-');
                const changeDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                changeDate.setHours(0, 0, 0, 0);

                // Only include if change date is today or in the future
                if (changeDate < today) {
                    return null;
                }

                // Compare current times with next times to find what's changing
                const prayerFields = {
                    'Fajr': { current: 'fajr_iqama_time', next: 'fajr_iqama' },
                    'Dhuhr': { current: 'zuhr_iqama_time', next: 'zuhr_iqama' },
                    'Asr': { current: 'asr_iqama_time', next: 'asr_iqama' },
                    'Isha': { current: 'isha_iqama_time', next: 'isha_iqama' }
                };

                const changes = [];
                for (const [prayer, fields] of Object.entries(prayerFields)) {
                    const currentTime = data[fields.current];
                    const nextTime = nextChange[fields.next];

                    if (nextTime && currentTime !== nextTime) {
                        changes.push(`${prayer} ${formatTime(currentTime)} ‚Üí ${formatTime(nextTime)}`);
                    }
                }

                if (changes.length > 0) {
                    return {
                        masjidName: masjidName,
                        changeDate: changeDate,
                        changeDateStr: changeDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                        changes: changes
                    };
                }
                return null;
            }

            // Get changes for both masjids
            const changes1 = getChangesForMasjid(data1, masjidName1);
            const changes2 = data2 ? getChangesForMasjid(data2, masjidName2) : null;

            // Build merged banner
            if (changes1 || changes2) {
                let bannerContent = '';

                // Check if both have changes on the same date
                if (changes1 && changes2 && changes1.changeDateStr === changes2.changeDateStr) {
                    // Same date - merge into one banner
                    bannerContent = `Iqamah changing ${changes1.changeDateStr}:<br>`;
                    bannerContent += `<strong>${changes1.masjidName}</strong>: ${changes1.changes.join(', ')}<br>`;
                    bannerContent += `<strong>${changes2.masjidName}</strong>: ${changes2.changes.join(', ')}`;
                } else {
                    // Different dates or only one masjid - show separately
                    const parts = [];
                    if (changes1) {
                        parts.push(`<strong>${changes1.masjidName}</strong> changing ${changes1.changeDateStr}: ${changes1.changes.join(', ')}`);
                    }
                    if (changes2) {
                        parts.push(`<strong>${changes2.masjidName}</strong> changing ${changes2.changeDateStr}: ${changes2.changes.join(', ')}`);
                    }
                    bannerContent = parts.join('<br>');
                }

                changesHtml = `<div class="mptsi-alert">${bannerContent}</div>`;
            }

            // Jumuah times - handle both array format and legacy format
            let jumuahHtml = '';
            const jumuahTimes = [];

            // Check for array format first (new API format)
            if (data1.jumma && Array.isArray(data1.jumma) && data1.jumma.length > 0) {
                data1.jumma.forEach((j, index) => {
                    const talk = formatTime(j.azan_time);
                    const prayer = formatTime(j.iqama_time);
                    if (prayer && prayer !== '-') {
                        jumuahTimes.push({
                            talk: talk,
                            prayer: prayer,
                            label: `Jumu'ah ${index + 1}`,
                            masjid: ''
                        });
                    }
                });
            } else {
                // Fallback to legacy format (jumma1_iqama, jumma2_iqama, etc.)
                const getJumuahData = (num) => {
                    const prayerM1 = formatTime(data1[`jumma${num}_iqama`]);
                    const prayerM2 = data2 ? formatTime(data2[`jumma${num}_iqama`]) : '';
                    let talkM1 = formatTime(data1[`jumma${num}_azan`]) || formatTime(data1[`jumma${num}_start_time`]);

                    const m1Valid = prayerM1 && prayerM1 !== '-';
                    const m2Valid = prayerM2 && prayerM2 !== '-';

                    if (m1Valid || m2Valid) {
                        return {
                            talk: talkM1,
                            prayer: m1Valid ? prayerM1 : prayerM2,
                            label: `Jumu'ah ${num}`,
                            masjid: (m1Valid && m2Valid) ? '' : (m1Valid ? masjidName1 : masjidName2)
                        };
                    }
                    return null;
                };

                [1, 2, 3].forEach(num => {
                    const jData = getJumuahData(num);
                    if (jData) jumuahTimes.push(jData);
                });
            }

            if (jumuahTimes.length > 0) {
                let jumuahItems = '';
                for (const j of jumuahTimes) {
                    const talkHtml = (j.talk && j.talk !== '-') ?
                        `<div class="mptsi-jumuah-time"><span style="font-size: 11px; font-weight: 400; color: #666;">Talk</span> ${j.talk}</div>` : '';
                    const masjidHtml = j.masjid ?
                        `<div style="font-size: 9px; color: #0066cc; margin-top: 2px;">${j.masjid}</div>` : '';

                    jumuahItems += `
                        <div class="mptsi-jumuah-item">
                            ${talkHtml}
                            <div class="mptsi-jumuah-time"><span style="font-size: 11px; font-weight: 400; color: #666;">Prayer</span> ${j.prayer}</div>
                            <div class="mptsi-jumuah-label">${j.label}</div>
                            ${masjidHtml}
                        </div>
                    `;
                }
                jumuahHtml = `
                    <div class="mptsi-jumuah">
                        <div class="mptsi-jumuah-grid">${jumuahItems}</div>
                    </div>
                `;
            }

            // Sunrise/Sunset
            const sunrise = formatTime(data1.shuruq);
            const sunset = formatTime(data1.magrib_start_time);
            const sunHtml = (sunrise && sunrise !== '-') || (sunset && sunset !== '-') ? `
                <div class="mptsi-sun">
                    <div class="mptsi-sun-item">
                        <span>üåÖ</span>
                        <span><strong>Sunrise</strong> ${sunrise}</span>
                    </div>
                    <div class="mptsi-sun-item">
                        <span><strong>Sunset</strong> ${sunset}</span>
                        <span>üåá</span>
                    </div>
                </div>
            ` : '';

            // Full widget HTML
            container.innerHTML = `
                <div class="mptsi-widget">
                    <div class="mptsi-header">
                        <h2>Prayer Timings</h2>
                        <div class="date">${todayDate}${hijriDate ? ' | ' + hijriDate : ''}</div>
                        ${changesHtml}
                    </div>

                    <div class="mptsi-table">
                        <div class="mptsi-row header ${!hasTwoMasjids ? 'single-masjid' : ''}">
                            <span></span>
                            <span style="text-align: center;">Azan</span>
                            <span style="text-align: center;">${hasTwoMasjids ? masjidName1 : 'Iqamah'}</span>
                            ${hasTwoMasjids ? `<span style="text-align: center;">${masjidName2}</span>` : ''}
                        </div>
                        ${prayerRows}
                    </div>

                    ${alertHtml}
                    ${jumuahHtml}
                    ${sunHtml}

                    <a href="https://www.masjidiapp.com/IqamaCalculator/Customized_UI_Yearly-3.htm?download=1&masjid_id=${CONFIG.masjidId1}" class="mptsi-link" target="_blank">
                        üìÖ View Monthly Prayer Schedule
                    </a>
                </div>
            `;
        }

        // Initialize
        async function init() {
            const container = document.getElementById('widget-container');
            container.innerHTML = '<div class="loading">Loading prayer times...</div>';

            try {
                const [data1, data2] = await Promise.all([
                    fetchMasjidData(CONFIG.masjidId1),
                    CONFIG.masjidId2 ? fetchMasjidData(CONFIG.masjidId2) : Promise.resolve(null)
                ]);

                // Debug: log the API response to see the format
                console.log('API Response for Masjid 1:', data1);
                if (data2) console.log('API Response for Masjid 2:', data2);

                // Only render once data is loaded
                if (data1) {
                    renderWidget(data1, data2);
                } else {
                    container.innerHTML = '<div class="error">Unable to load prayer times. Please check the Masjid ID or API key.</div>';
                }
            } catch (error) {
                console.error('Error initializing widget:', error);
                container.innerHTML = '<div class="error">Error loading prayer times. Please try again.</div>';
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
